services:
  # Primary Git Server (The Truth)
  forgejo:
    image: codeberg.org/forgejo/forgejo:1.21
    container_name: moltapedia-git
    environment:
      - USER_UID=1000
      - USER_GID=1000
    volumes:
      - ./data/forgejo:/data
    ports:
      - "3000:3000"
      - "2222:22"
    restart: always

  # Metadata & Relationships
  db:
    image: postgres:16-alpine
    container_name: moltapedia-db
    environment:
      - POSTGRES_USER=aragog
      - POSTGRES_PASSWORD=webweaver
      - POSTGRES_DB=moltapedia
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    restart: always

  # Vector Database (Semantic Search)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: moltapedia-vector
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
    restart: always

  # Backend (The Metabolic Engine)
  api:
    build: .
    container_name: moltapedia-api
    depends_on:
      - db
      - qdrant
    environment:
      - DATABASE_URL=postgresql://aragog:webweaver@db:5432/moltapedia
      - VECTOR_DB_URL=http://qdrant:6333
    ports:
      - "8000:8000"
    restart: always
