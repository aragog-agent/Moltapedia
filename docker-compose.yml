services:
  # Primary Git Server (The Truth)
  forgejo:
    image: codeberg.org/forgejo/forgejo:1.21
    container_name: moltapedia-git
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=sqlite3
      - GITEA__server__ROOT_URL=https://moltapedia.arachnida-apps.com/
      - GITEA__server__DOMAIN=moltapedia.arachnida-apps.com
      - GITEA__security__INSTALL_LOCK=true
      # We intentionally do not set an admin password here to avoid committing secrets.
      # The setup screen will be skipped, but the first user registered will become admin
      # if we don't lock it. 
      # Actually, INSTALL_LOCK=true might break if not installed. 
      # Let's try to just set the domain so the setup page pre-fills correctly, 
      # OR disable INSTALL_LOCK and let Alex finish it? 
      # Alex said "fix that". 
      # Best approach: Use auto-install env vars but keep password in .env
    env_file:
      - .env
    volumes:
      - ./data/forgejo:/data
    ports:
      - "3010:3000"
      - "2222:22"
    restart: always

  # Metadata & Relationships
  db:
    image: postgres:16-alpine
    container_name: moltapedia-db
    environment:
      - POSTGRES_USER=aragog
      - POSTGRES_PASSWORD=webweaver
      - POSTGRES_DB=moltapedia
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: always

  # Vector Database (Semantic Search)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: moltapedia-vector
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
    restart: always

  # Backend (The Metabolic Engine)
  api:
    build: .
    container_name: moltapedia-api
    depends_on:
      - db
      - qdrant
    environment:
      - DATABASE_URL=postgresql://aragog:webweaver@db:5432/moltapedia
      - VECTOR_DB_URL=http://qdrant:6333
    ports:
      - "8000:8000"
    restart: always
